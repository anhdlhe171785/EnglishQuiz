@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using PRN222_EnglishQuiz.Models

@{
    ViewData["Title"] = "Test Result";
    var questions = ViewBag.Questions as List<Question>;
    var form = ViewBag.UserAnswers as IFormCollection;
    int total = ViewBag.Total;
    int correct = ViewBag.Correct;
    double score = ViewBag.Score;
}

<h2>Test Result</h2>

<div class="mb-4">
    <p><strong>Total Questions:</strong> @total</p>
    <p><strong>Correct Answers:</strong> @correct</p>
    <p><strong>Score:</strong> <span style="color: green; font-size: 1.5em;">@score / 10</span></p>
</div>

<h3>Test Details</h3>

@for (int i = 0; i < questions.Count; i++)
{
    var q = questions[i];
    var userAnswer = form[$"answers[{q.Id}]"];
    bool isEmpty = string.IsNullOrEmpty(userAnswer);
    bool isCorrect = (!isEmpty && userAnswer == q.CorrectOption);

    <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #ccc; border-radius: 8px;">
        <p><strong>Câu @(@i + 1):</strong> @q.Content</p>
        <ul style="list-style-type: none; padding-left: 0;">
            @foreach (var opt in new[] { "A", "B", "C", "D", "E" })
            {
                var optText = opt switch
                {
                    "A" => q.OptionA,
                    "B" => q.OptionB,
                    "C" => q.OptionC,
                    "D" => q.OptionD,
                    "E" => q.OptionE,
                    _ => ""
                };
                if (string.IsNullOrWhiteSpace(optText))
                {
                    continue; // Bỏ qua nếu option trống
                }

                var isUserAnswer = userAnswer == opt;
                var isCorrectAnswer = q.CorrectOption == opt;

                <li style="@(isUserAnswer ? "font-weight:bold;" : "")">
                    @opt. @optText
                    @if (isCorrectAnswer)
                    {
                        <span style="color:green">✔</span>
                    }
                    @if (isUserAnswer && !isCorrectAnswer)
                    {
                        <span style="color:red">✘</span>
                    }
                </li>
            }
        </ul>

        <p>
            👉 Your answer:
            <strong>
                @Html.Raw(isEmpty ? "<span style='color:gray;'>No answer</span>" : userAnswer)
            </strong>
        </p>

        <p>
            Result:
            @if (isCorrect)
            {
                <span style="color: green; font-weight: bold;">✅ Correct</span>
            }
            else if (isEmpty)
            {
                <span style="color: orange; font-weight: bold;">⚠️ Skipped</span>
            }
            else if (isEmpty)
            {
                <span style="color: orange; font-weight: bold;">⚠️ Bỏ qua</span>
            }
            else
            {
                <span style="color: red; font-weight: bold;">❌ Incorrect</span>
            }
        </p>
    </div>
}

<a asp-action="Index" asp-controller="Exam" class="btn btn-primary mt-4">Back to Exam List</a>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Chặn nút back trình duyệt
        history.pushState(null, '', location.href);
        window.onpopstate = function () {
            history.go(1);
        };

        // Thông báo điểm số bằng popup
        Swal.fire({
            title: '🎉 Completed!',
            html: `You answered correctly <b>${@correct}</b> out of <b>${@total}</b> questions<br>Score: <b style="color: green;">${@score}</b> / 10`,
            icon: 'success',
            confirmButtonText: 'OK'
        });
    </script>
}
